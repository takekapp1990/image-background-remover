# 画像背景削除ツール

このツールは、画像の背景を自動的に削除し、透過画像として保存するPythonスクリプトです。

## 機能

- 画像の背景を自動的に検出し、削除
- 背景色を指定して削除
- 境界部分の処理による自然な背景削除
- 出力サイズのカスタマイズ
- バッチ処理対応
- 高速な画像処理（NumPyによる最適化）

## 使用方法

### 基本的な使い方

```bash
python main.py [オプション]
```

### オプション

- `--input-dir`: 入力画像を配置するディレクトリ（デフォルト: "input"）
- `--output-dir`: 処理済み画像を保存するディレクトリ（デフォルト: "output"）
- `--mode`: 背景削除モード（"auto" または "rembg"）（デフォルト: "auto"）
- `--prefix`: 出力ファイル名のプレフィックス（デフォルト: ""）
- `--output-size`: 出力画像のサイズ（例: "800 800"）（デフォルト: 元画像のサイズ）

### 例

```bash
# 基本的な使用方法
python main.py

# カスタム設定での使用
python main.py --input-dir "my_images" --output-dir "processed" --mode "auto" --prefix "processed_" --output-size 800 800
```

## 設定パラメータ

### 背景削除の設定
- `DEFAULT_MARGIN_RATIO`: 前景のスケーリング比率（デフォルト: 0.1）

### 背景色検出の設定
- `EDGE_SAMPLE_SIZE`: 端からサンプリングするピクセル数（デフォルト: 5）
- `COLOR_THRESHOLD`: 背景色と判断する色の差の閾値（デフォルト: 5）
  - 値が小さいほど厳密な判定になります
  - 5: 厳密な判定（推奨）
  - 10: 中程度の判定
  - 20以上: 緩い判定

### 境界処理の設定
- `BOUNDARY_DILATION_SIZE`: 境界部分の拡張範囲（ピクセル数）（デフォルト: 10）
- `BOUNDARY_COLOR_THRESHOLD`: 境界部分の色の類似度判定の閾値（デフォルト: 10）
  - 値が大きいほど境界部分の色の判定が緩くなります
  - 5: 厳密な判定（背景色に近い色のみ透過）
  - 10: 中程度の判定（推奨）
  - 20以上: 緩い判定（より広い範囲の色を透過）

### rembgの背景削除パラメータ
- `ALPHA_MATTING`: アルファマット処理の有効/無効（デフォルト: False）
- `ALPHA_MATTING_FOREGROUND_THRESHOLD`: 前景と判断する閾値（デフォルト: 240）
- `ALPHA_MATTING_BACKGROUND_THRESHOLD`: 背景と判断する閾値（デフォルト: 10）
- `ALPHA_MATTING_ERODE_SIZE`: エロード処理のサイズ（デフォルト: 10）
- `POST_PROCESS_MASK`: 後処理マスクの有効/無効（デフォルト: True）

## パフォーマンス最適化

このツールは以下の最適化により、高速な処理を実現しています：

1. NumPyによるベクトル化演算
   - ピクセルごとのループ処理を削減
   - 効率的な境界検出アルゴリズム
   - 一括処理による色の類似度計算

2. メモリ使用の最適化
   - 中間結果の効率的な保持
   - 不要な配列のコピーを削減

3. 境界処理の効率化
   - 境界検出の一括処理
   - 拡張処理の最適化
   - マスク演算による条件分岐の削減

## 依存パッケージ

- Python 3.6以上
- Pillow
- numpy
- rembg

## インストール方法

```bash
pip install -r requirements.txt
```

## 注意事項

- 入力画像はPNG、JPG、JPEG形式に対応しています
- 出力画像はPNG形式で保存されます
- 背景色の自動検出は画像の端の色をサンプリングして行います
- 境界処理のパラメータは画像の特性に応じて調整してください
- 大きな画像や`BOUNDARY_DILATION_SIZE`が大きい場合でも高速に処理できます 